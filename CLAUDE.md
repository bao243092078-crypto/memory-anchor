# Memory Anchorï¼ˆè®°å¿†é”šç‚¹ï¼‰é¡¹ç›®è§„åˆ™

## é¡¹ç›®å®šä½
ä¸ºé˜¿å°”èŒ¨æµ·é»˜ç—‡æ‚£è€…åŠå…¶ç…§æŠ¤è€…æä¾›ä¾¿åˆ©è´´å¼è®°å¿†è¾…åŠ©ç³»ç»Ÿã€‚
**æ ¸å¿ƒåŸåˆ™**ï¼šæç®€ > åŠŸèƒ½ä¸°å¯Œï¼Œä¸»åŠ¨æé†’ > è¢«åŠ¨è®°å½•

---

## ğŸš¨ æ ‡å‡†å¼€åœºæµç¨‹ï¼ˆæ¯æ¬¡æ–°ä¼šè¯å¼ºåˆ¶æ‰§è¡Œï¼‰

> **è¿™æ˜¯å›ºå®šæŒ‡ä»¤å—ï¼ŒClaude å¿…é¡»åœ¨å›ç­”ç”¨æˆ·é—®é¢˜å‰å…ˆæ‰§è¡Œä»¥ä¸‹æ­¥éª¤**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 0: è¯»å–ç”¨æˆ·è¾“å…¥                                        â”‚
â”‚     â†“                                                        â”‚
â”‚  Step 1: ç”¨ä¸€å¥è¯æ€»ç»“ç”¨æˆ·éœ€æ±‚ â†’ query                         â”‚
â”‚     â†“                                                        â”‚
â”‚  Step 2: è°ƒç”¨ mcp__memory-anchor__search_memory(query)       â”‚
â”‚     â†“                                                        â”‚
â”‚  Step 3: å¼•ç”¨æœç´¢ç»“æœï¼Œå¼€å§‹å›ç­”é—®é¢˜/å†™ä»£ç                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç¤ºä¾‹æ‰§è¡Œ**ï¼š
```
ç”¨æˆ·ï¼š"å¸®æˆ‘æŸ¥ä¸€ä¸‹å¥³å„¿çš„ç”µè¯"

Claude å†…éƒ¨æ‰§è¡Œï¼š
1. query = "å¥³å„¿ç”µè¯è”ç³»æ–¹å¼"
2. è°ƒç”¨ search_memory(query="å¥³å„¿ç”µè¯è”ç³»æ–¹å¼")
3. è·å–ç»“æœï¼š[å®ªæ³•å±‚] å¥³å„¿ç‹å°çº¢ï¼Œç”µè¯13800138000
4. å›ç­”ç”¨æˆ·ï¼š"æ ¹æ®è®°å¿†ï¼Œæ‚¨çš„å¥³å„¿æ˜¯ç‹å°çº¢ï¼Œç”µè¯æ˜¯13800138000"
```

**è·³è¿‡æ¡ä»¶**ï¼ˆä»…ä»¥ä¸‹æƒ…å†µå¯è·³è¿‡ search_memoryï¼‰ï¼š
- ç”¨æˆ·æ˜ç¡®è¯´"ä¸ç”¨æŸ¥è®°å¿†"
- å·²ç»åœ¨æœ¬ä¼šè¯ä¸­æŸ¥è¿‡ç›¸åŒå†…å®¹

---

## ğŸ”´ ç¡¬çº¦æŸï¼šå…ˆæŸ¥è®°å¿†å†åŠ¨æ‰‹

> **æ ¸å¿ƒè§„åˆ™**ï¼šå¦‚æœå½“å‰ä»»åŠ¡ä¸æ˜¯"å®Œå…¨æ–°ä¸œè¥¿"ï¼Œå°±å¿…é¡»å…ˆ search_memoryã€‚

### å¿…é¡»å…ˆæŸ¥è®°å¿†çš„åœºæ™¯

| åœºæ™¯ | ç¤ºä¾‹é—®é¢˜ | ä¸ºä»€ä¹ˆè¦æŸ¥ |
|------|---------|-----------|
| **æ¶‰åŠé¡¹ç›®å†å²** | "ä¸Šæ¬¡æˆ‘ä»¬è®¨è®ºçš„..." | é¿å…é‡å¤åŠ³åŠ¨ |
| **æ¶‰åŠè®¾è®¡å†³ç­–** | "ä¸ºä»€ä¹ˆç”¨ Qdrantï¼Ÿ" | æŸ¥å‡ºå½“åˆçš„ç†ç”± |
| **æ¶‰åŠ Bug/ä¿®å¤** | "ä¹‹å‰é‚£ä¸ªç©ºæŒ‡é’ˆé—®é¢˜" | æŸ¥å‡ºä¿®å¤ç»†èŠ‚ |
| **æ¶‰åŠä¸Šä¸‹æ–‡** | "ç»§ç»­ä¸Šæ¬¡çš„ä»»åŠ¡" | æ¢å¤å·¥ä½œçŠ¶æ€ |
| **ä¸ç¡®å®šæ˜¯å¦æ–°ä¸œè¥¿** | ä»»ä½•æ¨¡ç³Šçš„ä»»åŠ¡ | å®å¯å¤šæŸ¥ä¸€æ¬¡ |

### ä¸æŸ¥è®°å¿† = ä¸åˆè§„èŒƒ

```
âŒ é”™è¯¯è¡Œä¸ºï¼š
ç”¨æˆ·ï¼š"ä¸Šæ¬¡æˆ‘ä»¬ä¿®å¤çš„ search_memory Bug æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Ÿ"
Claudeï¼šï¼ˆç›´æ¥å‡­è®°å¿†å›ç­”ï¼Œæˆ–è¯´"æˆ‘ä¸è®°å¾—"ï¼‰

âœ… æ­£ç¡®è¡Œä¸ºï¼š
ç”¨æˆ·ï¼š"ä¸Šæ¬¡æˆ‘ä»¬ä¿®å¤çš„ search_memory Bug æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Ÿ"
Claudeï¼š
1. è°ƒç”¨ search_memory(query="search_memory Bug ä¿®å¤")
2. è·å–ç»“æœï¼š[fact] ä¿®å¤ search_memory ç©ºæŸ¥è¯¢æ—¶è¿”å› None å¯¼è‡´ç©ºæŒ‡é’ˆ...
3. å¼•ç”¨ç»“æœå›ç­”ç”¨æˆ·
```

### è‡ªæ£€æ¸…å•

åœ¨å›ç­”æ¶‰åŠ"å†å²/å†³ç­–/Bug/ä¸Šä¸‹æ–‡"çš„é—®é¢˜å‰ï¼ŒClaude åº”è‡ªé—®ï¼š
- [ ] è¿™ä¸ªé—®é¢˜éœ€è¦é¡¹ç›®å†å²ä¿¡æ¯å—ï¼Ÿâ†’ æ˜¯ â†’ å…ˆ search_memory
- [ ] è¿™ä¸ªé—®é¢˜æ¶‰åŠä¹‹å‰çš„å†³ç­–å—ï¼Ÿâ†’ æ˜¯ â†’ å…ˆ search_memory
- [ ] æˆ‘ä¸ç¡®å®šè¿™æ˜¯ä¸æ˜¯"æ–°ä¸œè¥¿"ï¼Ÿâ†’ æ˜¯ â†’ å…ˆ search_memory

**è¿ååæœ**ï¼šç”¨æˆ·å¯ä»¥ç›´æ¥è¯´"ä½ æŸ¥è®°å¿†äº†å—ï¼Ÿ"ï¼ŒClaude å¿…é¡»é‡æ–°æ‰§è¡Œæµç¨‹ã€‚

---

## ğŸŸ¢ ç»“æŸæµç¨‹ï¼šå†™å…¥ Observationï¼ˆæ¯è½®ä»»åŠ¡å®Œæˆæ—¶å¼ºåˆ¶æ‰§è¡Œï¼‰

> **æ ¸å¿ƒè§„åˆ™**ï¼šæ¯å½“ä¸€è½®ä»»åŠ¡å®Œæˆï¼ˆç”¨æˆ·è¯´"å¥½äº†"ã€"å®Œæˆäº†"ã€"å¯ä»¥äº†"ï¼Œæˆ– Claude ä¸»åŠ¨è¯´"è¿™ä¸€è½®å®Œæˆäº†"ï¼‰ï¼Œå¿…é¡»æ‰§è¡Œä»¥ä¸‹æµç¨‹ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: å¤ç›˜åˆšæ‰å‘ç”Ÿäº†ä»€ä¹ˆ                                  â”‚
â”‚     â†“                                                        â”‚
â”‚  Step 2: ç”Ÿæˆç»“æ„åŒ– Observation                              â”‚
â”‚     â†“                                                        â”‚
â”‚  Step 3: è°ƒç”¨ add_memory å†™å…¥ memory-anchor                  â”‚
â”‚     â†“                                                        â”‚
â”‚  Step 4: å‘ŠçŸ¥ç”¨æˆ·"å·²è®°å½•åˆ°è®°å¿†ç³»ç»Ÿ"                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Observation JSON Schema

```json
{
  "type": "å†³ç­–ç±»å‹",
  "summary": "ä¸€å¥è¯æè¿°å‘ç”Ÿäº†ä»€ä¹ˆ",
  "layer": "fact | session",
  "category": "person | place | event | item | routine",
  "confidence": 0.95
}
```

### type æšä¸¾åŠç¤ºä¾‹

| type | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `decision` | è®¾è®¡/æ¶æ„å†³ç­– | "å†³å®šä½¿ç”¨ Qdrant Server æ¨¡å¼è§£å†³å¹¶å‘é”é—®é¢˜" |
| `bugfix` | Bug ä¿®å¤ | "ä¿®å¤äº† search_memory ç©ºæŸ¥è¯¢è¿”å› None å¯¼è‡´ç©ºæŒ‡é’ˆ" |
| `feature` | æ–°åŠŸèƒ½å®Œæˆ | "å®Œæˆäº†å®ªæ³•å±‚ä¸‰æ¬¡å®¡æ‰¹æœºåˆ¶" |
| `refactor` | é‡æ„ | "å°† SearchService æ”¹ä¸ºæ”¯æŒ Server/Local åŒæ¨¡å¼" |
| `discovery` | å‘ç°/è°ƒç ”ç»“è®º | "å‘ç° Qdrant æœ¬åœ°æ¨¡å¼ä¸æ”¯æŒå¹¶å‘è®¿é—®" |
| `sprint` | Sprint/é‡Œç¨‹ç¢‘å®Œæˆ | "Sprint 3 å®Œæˆäº†å®ªæ³•å±‚ä¸‰æ¬¡å®¡æ‰¹æœºåˆ¶" |

### ç¤ºä¾‹æ‰§è¡Œ

```
ç”¨æˆ·ï¼š"å¥½äº†ï¼Œè¿™ä¸ª Bug ä¿®å¥½äº†"

Claude å†…éƒ¨æ‰§è¡Œï¼š
1. å¤ç›˜ï¼šåˆšæ‰ä¿®å¤äº† Qdrant å¹¶å‘é”é—®é¢˜
2. ç”Ÿæˆ Observationï¼š
   {
     "type": "bugfix",
     "summary": "ä¿®å¤ Qdrant å¹¶å‘é”ï¼šåˆ‡æ¢åˆ° Server æ¨¡å¼ï¼Œsearch.py æ”¯æŒè‡ªåŠ¨æ£€æµ‹å’Œé™çº§",
     "layer": "fact",
     "category": "event",
     "confidence": 0.95
   }
3. è°ƒç”¨ add_memory(content="ä¿®å¤ Qdrant å¹¶å‘é”...", layer="fact", category="event", confidence=0.95)
4. å›å¤ç”¨æˆ·ï¼š"âœ… å·²å®Œæˆï¼Œå¹¶è®°å½•åˆ°è®°å¿†ç³»ç»Ÿã€‚ä¸‹æ¬¡å¯ä»¥é€šè¿‡ search_memory æŸ¥è¯¢è¿™æ¬¡ä¿®å¤ã€‚"
```

### å¿…é¡»å†™å…¥ Observation çš„åœºæ™¯

| åœºæ™¯ | layer | category |
|------|-------|----------|
| åšäº†é‡è¦å†³ç­– | fact | event |
| ä¿®å¤äº† Bug | fact | event |
| å®Œæˆäº†æ–°åŠŸèƒ½ | fact | event |
| å®Œæˆäº†é‡æ„ | fact | event |
| å‘ç°äº†é‡è¦ä¿¡æ¯ | fact | æŒ‰å†…å®¹ |
| Sprint/é‡Œç¨‹ç¢‘å®Œæˆ | fact | event |
| ä¸€è½®å¯¹è¯ç»“æŸï¼ˆæœ‰å®è´¨è¿›å±•ï¼‰ | session | event |

### è·³è¿‡æ¡ä»¶

- ä»…é—²èŠï¼Œæ— å®è´¨ä»£ç /å†³ç­–å˜æ›´
- ç”¨æˆ·æ˜ç¡®è¯´"ä¸ç”¨è®°å½•"

---

## æŠ€æœ¯æ ˆ
- åç«¯: Python 3.12 + FastAPI + Pydantic
- å‰ç«¯: React 18 + Tailwind CSS + PWA
- å­˜å‚¨: SQLite + Qdrantï¼ˆ.memos/ å·²åˆå§‹åŒ–ï¼‰
- AI: Claude APIï¼ˆè¯­ä¹‰æå–ï¼‰+ Edge TTSï¼ˆè¯­éŸ³ï¼‰

## ç›®å½•ç»“æ„
```
.
â”œâ”€â”€ backend/          # FastAPI åç«¯
â”‚   â”œâ”€â”€ api/         # è·¯ç”±
â”‚   â”œâ”€â”€ models/      # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ services/    # ä¸šåŠ¡é€»è¾‘
â”‚   â””â”€â”€ tests/       # æµ‹è¯•
â”œâ”€â”€ frontend/         # React å‰ç«¯
â”‚   â”œâ”€â”€ caregiver/   # ç…§æŠ¤è€…ç«¯
â”‚   â””â”€â”€ patient/     # æ‚£è€…ç«¯
â”œâ”€â”€ docs/            # æ–‡æ¡£
â”‚   â”œâ”€â”€ SPEC.md      # äº§å“è§„æ ¼
â”‚   â””â”€â”€ brainstorm.md # å¤´è„‘é£æš´
â””â”€â”€ .memos/          # MOS æ•°æ®ç›®å½•ï¼ˆå‹¿åŠ¨ï¼‰
```

## ä¸‰å±‚è®°å¿†è§„åˆ™
1. **å®ªæ³•å±‚**ï¼šæ ¸å¿ƒèº«ä»½ï¼Œä»…ç…§æŠ¤è€…å¯æ”¹ï¼Œ**éœ€ä¸‰æ¬¡CLIç¡®è®¤**
2. **äº‹å®å±‚**ï¼šé•¿æœŸè®°å¿†ï¼ŒAI å¯æå–ï¼Œäººå·¥å¯ä¿®æ­£
3. **ä¼šè¯å±‚**ï¼šçŸ­æœŸå¯¹è¯ï¼Œ24h åå½’æ¡£

## å¼€å‘çº¦å®š
- æ¯ä¸ª PR å¿…é¡»æœ‰æµ‹è¯•
- æ‚£è€…ç«¯ UI å¿…é¡»é€šè¿‡"ç¥–æ¯æµ‹è¯•"ï¼ˆéæŠ€æœ¯äººå‘˜å¯ç†è§£ï¼‰
- æ•æ„Ÿæ•°æ®ä¸è®°å½•æ—¥å¿—
- é”™è¯¯ä¿¡æ¯å¯¹æ‚£è€…å‹å¥½ï¼ˆ"ç¨ç­‰ä¸€ä¸‹"è€Œé"500 Error"ï¼‰

## å¿«æ·å‘½ä»¤
```bash
uv run dev      # å¯åŠ¨å¼€å‘æœåŠ¡å™¨ (localhost:8000)
uv run test     # è¿è¡Œæµ‹è¯•
uv run lint     # ä»£ç æ£€æŸ¥
```

## ç¦æ­¢è¡Œä¸º
- ä¸è¦åœ¨æ—¥å¿—ä¸­è®°å½•ä¾¿åˆ©è´´å†…å®¹ï¼ˆéšç§ï¼‰
- ä¸è¦ä½¿ç”¨çº¢è‰²è­¦å‘Šè‰²ï¼ˆå¯¹æ‚£è€…æœ‰å‹åŠ›ï¼‰
- ä¸è¦è‡ªåŠ¨åˆ é™¤ä»»ä½•æ•°æ®
- ä¸è¦åœ¨ .memos/ ç›®å½•æ‰‹åŠ¨ä¿®æ”¹æ–‡ä»¶

## API è·¯ç”±çº¦å®š
- `GET /api/notes` - è·å–ä¾¿åˆ©è´´åˆ—è¡¨
- `POST /api/notes` - åˆ›å»ºä¾¿åˆ©è´´
- `PUT /api/notes/{id}` - æ›´æ–°ä¾¿åˆ©è´´
- `DELETE /api/notes/{id}` - åˆ é™¤ä¾¿åˆ©è´´ï¼ˆè½¯åˆ é™¤ï¼‰
- `GET /api/search?q=` - è¯­ä¹‰æœç´¢
- `POST /api/tts` - æ–‡å­—è½¬è¯­éŸ³

## æ‚£è€…ç«¯ UI çº¢çº¿
- å­—ä½“ >= 24px
- å¯¹æ¯”åº¦ >= 4.5:1
- å•å±æ˜¾ç¤ºä¸€æ¡æ ¸å¿ƒä¿¡æ¯
- æ— éœ€ç‚¹å‡»å³å¯çœ‹åˆ°æœ€é‡è¦å†…å®¹

---

## Memory Anchor MCP ä½¿ç”¨ SOPï¼ˆå¼ºåˆ¶ï¼‰

> **é‡è¦**ï¼šæœ¬é¡¹ç›®ä½¿ç”¨ `memory-anchor` ä½œä¸º**å”¯ä¸€è®°å¿†æº**ï¼Œä¸è¦ä½¿ç”¨ claude-mem æˆ–å…¶ä»–è®°å¿†æ’ä»¶ã€‚

---

### Phase 1: ä¼šè¯åˆå§‹åŒ–ï¼ˆæ¯æ¬¡æ–°ä¼šè¯å¿…é¡»æ‰§è¡Œï¼‰

```python
# Step 1: åŠ è½½å®ªæ³•å±‚ï¼ˆæ ¸å¿ƒèº«ä»½ï¼‰
constitution = mcp__memory-anchor__get_constitution()
# å®ªæ³•å±‚å§‹ç»ˆå…¨é‡åŠ è½½ï¼Œä¸ä¾èµ–æ£€ç´¢

# Step 2: æ ¹æ®å½“å‰ä»»åŠ¡ç”Ÿæˆ query
task_summary = "ç”¨ä¸€å¥è¯æ€»ç»“å½“å‰ä»»åŠ¡æˆ–ç”¨æˆ·é—®é¢˜"
query = generate_query(task_summary)

# Step 3: æœç´¢ç›¸å…³è®°å¿†
memories = mcp__memory-anchor__search_memory(
    query=query,
    layer="fact",  # æˆ– "session" æˆ–çœç•¥æœå…¨éƒ¨
    limit=5
)

# Step 4: æ„å»ºä¸Šä¸‹æ–‡
context = {
    "constitution": constitution,  # æ°¸è¿œåœ¨æœ€å‰é¢
    "relevant_facts": memories,
    "user_query": user_input
}
```

**è§¦å‘æ¡ä»¶**ï¼š
- æ–°ä¼šè¯å¼€å§‹
- ç”¨æˆ·åˆ‡æ¢è¯é¢˜
- ç”¨æˆ·æ˜ç¡®è¯´"é‡æ–°åŠ è½½è®°å¿†"

---

### Phase 2: è®°å¿†å†™å…¥ï¼ˆå®Œæˆé‡è¦å·¥ä½œåï¼‰

```python
# å®Œæˆé‡è¦å·¥ä½œåï¼Œç”Ÿæˆ observation
def generate_observation(work_result):
    return {
        "content": "ç”¨ä¸€å¥è¯æè¿°å‘ç”Ÿäº†ä»€ä¹ˆ",
        "layer": "fact",  # fact | sessionï¼ˆå®ªæ³•å±‚ç¦æ­¢AIå†™å…¥ï¼‰
        "category": "event",  # person | place | event | item | routine
        "confidence": 0.85  # AI æå–æ—¶å¿…å¡«
    }

# è°ƒç”¨ add_memory
observation = generate_observation(work_result)
mcp__memory-anchor__add_memory(
    content=observation["content"],
    layer=observation["layer"],
    category=observation["category"],
    confidence=observation["confidence"]
)
```

**å¿…é¡»å†™å…¥è®°å¿†çš„åœºæ™¯**ï¼š

| åœºæ™¯ | layer | category | ç¤ºä¾‹ |
|------|-------|----------|------|
| é‡è¦å†³ç­– | fact | event | "å†³å®šä½¿ç”¨ Qdrant ä½œä¸ºå‘é‡æ•°æ®åº“" |
| Bug ä¿®å¤ | fact | event | "ä¿®å¤äº† search_memory çš„ç©ºæŒ‡é’ˆé—®é¢˜" |
| æ¶æ„å˜æ›´ | fact | item | "æ·»åŠ äº†ä¸‰å±‚è®°å¿†æ¨¡å‹" |
| å‘ç°å…³é”®ä¿¡æ¯ | fact | æŒ‰å†…å®¹ | "æ‚£è€…æåˆ°å¥³å„¿ä¸‹å‘¨è¦å‡ºå·®" |
| ä¼šè¯æ‘˜è¦ | session | - | "æœ¬æ¬¡ä¼šè¯è®¨è®ºäº† MCP é›†æˆæ–¹æ¡ˆ" |

---

### Phase 2.5: ç»“æŸè¯­ Promptï¼ˆä»»åŠ¡å®Œæˆæ—¶å¼ºåˆ¶æ‰§è¡Œï¼‰

> **è§¦å‘è¯**ï¼šå½“ç”¨æˆ·è¯´ä»¥ä¸‹è¯æ—¶ï¼Œå¿…é¡»æ‰§è¡Œæ­¤æµç¨‹ï¼š
> - "è¿™ä¸€è½®å®Œæˆäº†" / "è¿™ä¸ªä»»åŠ¡å®Œæˆäº†"
> - "è¿™ä¸ª Bug ä¿®å¥½äº†" / "æå®šäº†"
> - "å‘Šä¸€æ®µè½" / "å…ˆåˆ°è¿™é‡Œ"
> - "å­˜ä¸€ä¸‹è¿›åº¦"

**Claude å¿…é¡»æ‰§è¡Œçš„ä¸‰ä¸ªæ­¥éª¤ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: ç”¨è‡ªå·±çš„è¯å¤è¿°åˆšåˆšå‘ç”Ÿçš„å…³é”®äº‹ä»¶                     â”‚
â”‚     "åˆšæ‰æˆ‘ä»¬åšäº†ï¼š..."                                      â”‚
â”‚     â†“                                                        â”‚
â”‚  Step 2: ç”Ÿæˆç¬¦åˆ Observation JSON çš„å€™é€‰è®°å¿†                 â”‚
â”‚     å±•ç¤º JSONï¼Œè®©ç”¨æˆ·ç¡®è®¤                                    â”‚
â”‚     â†“                                                        â”‚
â”‚  Step 3: è¯¢é—®æ˜¯å¦å†™å…¥è®°å¿†                                    â”‚
â”‚     "æ˜¯å¦è¦å°†è¿™æ¡è®°å¿†å†™å…¥ memory-anchorï¼Ÿ(y/n)"              â”‚
â”‚     â†“                                                        â”‚
â”‚  Step 4: ç”¨æˆ·ç¡®è®¤åï¼Œè°ƒç”¨ add_memory                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Observation JSON æ¨¡æ¿**ï¼ˆå‚è€ƒ docs/MEMORY_STRATEGY.mdï¼‰ï¼š

```json
{
  "type": "<decision|bugfix|refactor|discovery|note>",
  "summary": "<ä¸€å¥è¯æ€»ç»“ï¼Œæœ€å¤š200å­—ç¬¦>",
  "details": "<å¯é€‰çš„è¯¦ç»†è¯´æ˜>",
  "files": ["<æ¶‰åŠçš„æ–‡ä»¶è·¯å¾„>"],
  "layer": "<fact|session>",
  "tags": ["<æ ‡ç­¾1>", "<æ ‡ç­¾2>"],
  "created_at": "<ISO 8601>",
  "author": "claude-code"
}
```

**ç±»å‹-å±‚çº§æ˜ å°„è§„åˆ™**ï¼š
| type | é»˜è®¤ layer | ä½•æ—¶ä½¿ç”¨ |
|------|-----------|---------|
| `decision` | fact | æ¶æ„/æŠ€æœ¯å†³ç­– |
| `bugfix` | fact | Bug ä¿®å¤ |
| `refactor` | fact | é‡æ„è®°å½• |
| `discovery` | session | å‘ç°/æ¢ç´¢ï¼ˆå¾…éªŒè¯ï¼‰ |
| `note` | session | ä¸´æ—¶ç¬”è®° |

**ç¤ºä¾‹å¯¹è¯**ï¼š

```
ç”¨æˆ·ï¼šè¿™ä¸ª Bug ä¿®å¥½äº†

Claudeï¼š
ğŸ“‹ **åˆšæ‰æˆ‘ä»¬åšäº†**ï¼š
ä¿®å¤äº† `search_memory` åœ¨ query ä¸ºç©ºæ—¶è¿”å› None å¯¼è‡´ç©ºæŒ‡é’ˆçš„é—®é¢˜ï¼Œ
æ”¹ä¸ºè¿”å›ç©ºåˆ—è¡¨ `[]`ã€‚

ğŸ“ **å€™é€‰è®°å¿†**ï¼š
{
  "type": "bugfix",
  "summary": "ä¿®å¤ search_memory ç©ºæŸ¥è¯¢æ—¶è¿”å› None å¯¼è‡´ç©ºæŒ‡é’ˆï¼Œæ”¹ä¸ºè¿”å›ç©ºåˆ—è¡¨",
  "details": null,
  "files": ["backend/services/memory.py"],
  "layer": "fact",
  "tags": ["bugfix", "search", "null-safety"],
  "created_at": "2025-12-11T17:00:00Z",
  "author": "claude-code"
}

æ˜¯å¦è¦å°†è¿™æ¡è®°å¿†å†™å…¥ memory-anchorï¼Ÿ(y/n)

ç”¨æˆ·ï¼šy

Claudeï¼š[è°ƒç”¨ mcp__memory-anchor__add_memory]
âœ… è®°å¿†å·²å†™å…¥ï¼ˆlayer=fact, confidence=0.9ï¼‰
```

**æ³¨æ„**ï¼š
- åªæœ‰ç”¨æˆ·ç¡®è®¤åæ‰è°ƒç”¨ `add_memory`
- `confidence` é»˜è®¤ 0.9ï¼ˆç»ç”¨æˆ·ç¡®è®¤çš„è®°å¿†ï¼‰
- `decision/bugfix/refactor` ç±»å‹ä½¿ç”¨ `layer=fact`
- `discovery/note` ç±»å‹ä½¿ç”¨ `layer=session`

---

### Phase 3: è®°å¿†å¼•ç”¨ï¼ˆå›ç­”é—®é¢˜æ—¶ï¼‰

```python
# åœ¨å›ç­”ç”¨æˆ·é—®é¢˜æˆ–å†™ä»£ç æ—¶
def respond_with_memory(user_query, context):
    # 1. ä¼˜å…ˆå¼•ç”¨å®ªæ³•å±‚ï¼ˆæ ¸å¿ƒèº«ä»½ï¼‰
    if is_identity_question(user_query):
        return format_from_constitution(context["constitution"])

    # 2. å¼•ç”¨æœç´¢ç»“æœ
    if context["relevant_facts"]:
        return incorporate_memories(user_query, context["relevant_facts"])

    # 3. æ— ç›¸å…³è®°å¿†æ—¶ï¼Œæ˜ç¡®å‘ŠçŸ¥
    return "æˆ‘æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è®°å¿†ï¼Œéœ€è¦ç…§æŠ¤è€…è¡¥å……"
```

---

### å››ä¸ª MCP å·¥å…·é€ŸæŸ¥

| å·¥å…· | ç”¨é€” | ä½•æ—¶è°ƒç”¨ |
|------|------|---------|
| `get_constitution` | è·å–æ‚£è€…æ ¸å¿ƒèº«ä»½ | æ¯ä¼šè¯å¼€å§‹ã€èº«ä»½ç›¸å…³é—®é¢˜ |
| `search_memory` | è¯­ä¹‰æœç´¢è®°å¿† | éœ€è¦å†å²ä¿¡æ¯æ—¶ |
| `add_memory` | æ·»åŠ æ–°è®°å¿† | å®Œæˆé‡è¦å·¥ä½œå |
| `propose_constitution_change` | æè®®ä¿®æ”¹å®ªæ³•å±‚ | éœ€è¦ä¿®æ”¹æ ¸å¿ƒèº«ä»½æ—¶ï¼ˆéœ€ä¸‰æ¬¡å®¡æ‰¹ï¼‰ |

### ç½®ä¿¡åº¦åˆ†çº§å¤„ç†

| ç½®ä¿¡åº¦ | å¤„ç†æ–¹å¼ | è¯´æ˜ |
|--------|----------|------|
| **â‰¥ 0.9** | ç›´æ¥å­˜å…¥äº‹å®å±‚ | é«˜ç½®ä¿¡åº¦ï¼Œæ— éœ€äººå·¥å®¡æ‰¹ |
| **0.7-0.9** | å­˜å…¥å¾…å®¡æ‰¹åŒº | éœ€ç…§æŠ¤è€…ç¡®è®¤ |
| **< 0.7** | æ‹’ç»å­˜å…¥ | ä¿¡æ¯å¤ªæ¨¡ç³Šï¼Œä¸¢å¼ƒ |

### çº¢çº¿ç¦æ­¢

- **ç¦æ­¢** AI ç›´æ¥å†™å…¥å®ªæ³•å±‚ï¼ˆå¿…é¡»é€šè¿‡ `propose_constitution_change`ï¼‰
- **ç¦æ­¢** ç»•è¿‡ä¸‰æ¬¡å®¡æ‰¹æœºåˆ¶ä¿®æ”¹å®ªæ³•å±‚
- **ç¦æ­¢** åœ¨æ—¥å¿—ä¸­è®°å½•ä¾¿åˆ©è´´å†…å®¹
- **ç¦æ­¢** æœªç»ç¡®è®¤è¦†ç›–å·²æœ‰è®°å¿†
- **ç¦æ­¢** ä½¿ç”¨ claude-mem æˆ–å…¶ä»–è®°å¿†æ’ä»¶ï¼ˆæœ¬é¡¹ç›®ä»…ç”¨ memory-anchorï¼‰

---

### å®ªæ³•å±‚ä¿®æ”¹æµç¨‹ï¼ˆä¸‰æ¬¡å®¡æ‰¹ï¼‰

> **å¼ºåˆ¶è§„åˆ™**ï¼šå®ªæ³•å±‚çš„ä»»ä½•ä¿®æ”¹ï¼Œå¿…é¡»é€šè¿‡ `propose_constitution_change`ï¼Œä¸å¾—ç›´æ¥ç¼–è¾‘ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: Claude è°ƒç”¨ propose_constitution_change            â”‚
â”‚     â†“                                                        â”‚
â”‚  Step 2: åˆ›å»º pending çŠ¶æ€çš„å˜æ›´æè®®                         â”‚
â”‚     â†“                                                        â”‚
â”‚  Step 3: ç…§æŠ¤è€…å®¡æ‰¹ï¼ˆè°ƒç”¨ 3 æ¬¡ /approve/{id}ï¼‰               â”‚
â”‚     â†“                                                        â”‚
â”‚  Step 4: approvals_count >= 3 æ—¶ï¼Œè‡ªåŠ¨åº”ç”¨å˜æ›´               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è°ƒç”¨ç¤ºä¾‹**ï¼š
```python
# æè®®æ–°å¢å®ªæ³•æ¡ç›®
mcp__memory-anchor__propose_constitution_change(
    change_type="create",
    proposed_content="æ‚£è€…å¥³å„¿ç‹å°çº¢ï¼Œç”µè¯13800138000",
    reason="ç…§æŠ¤è€…æä¾›çš„è”ç³»äººä¿¡æ¯",
    category="person"
)

# æè®®ä¿®æ”¹ç°æœ‰æ¡ç›®
mcp__memory-anchor__propose_constitution_change(
    change_type="update",
    proposed_content="æ‚£è€…å¥³å„¿ç‹å°çº¢ï¼Œæ–°ç”µè¯13900139000",
    reason="å¥³å„¿æ¢äº†æ–°å·ç ",
    target_id="åŸæ¡ç›®çš„UUID",
    category="person"
)
```

**å®¡æ‰¹ API**ï¼š
```bash
# ç…§æŠ¤è€…å®¡æ‰¹ï¼ˆæ¯æ¬¡è°ƒç”¨ +1ï¼Œéœ€è¦ 3 æ¬¡ï¼‰
POST /api/v1/constitution/approve/{change_id}

# æŸ¥çœ‹å¾…å®¡æ‰¹åˆ—è¡¨
GET /api/v1/constitution/pending
```

---

## è®°å¿†åŒæ­¥è§„åˆ™ï¼ˆè‡ªåŠ¨ç»§æ‰¿ï¼‰

> æœ¬é¡¹ç›®éµå¾ªå…¨å±€è®°å¿†åŒæ­¥è§„åˆ™ï¼Œè¯¦è§ `~/.claude/rules/13-memory-sync.md`

### å¿«é€Ÿå‚è€ƒ

- **Qdrant** æ˜¯è®°å¿†å•ä¸€çœŸç›¸æº
- **`.memos/`** æ˜¯äººç±»å¯è¯»å¤‡ä»½
- ä»»åŠ¡å®Œæˆåè°ƒç”¨ `add_memory` å†™å…¥
- ä¼šè¯å¼€å§‹æ—¶è°ƒç”¨ `search_memory` åŠ è½½ä¸Šä¸‹æ–‡

### è®°å¿†å—è§„èŒƒ

åœ¨æœ¬æ–‡ä»¶ä¸­ä½¿ç”¨ç»“æ„åŒ–è®°å¿†å—ï¼š

```memory-anchor
id: unique-id
type: decision | bugfix | refactor | discovery | note
summary: ä¸€å¥è¯æ€»ç»“
layer: fact | session
tags: [tag1, tag2]
```
