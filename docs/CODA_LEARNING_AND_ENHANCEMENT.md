# CoDA å­¦ä¹ æŠ¥å‘Š & Memory Anchor å¢å¼ºæ–¹æ¡ˆ

> **ç‰ˆæœ¬**: 1.0.0
> **æ—¥æœŸ**: 2025-12-25
> **æ¥æº**: CoDA è®ºæ–‡æ·±åº¦ç ”ç©¶ + å…¨ç½‘æŠ€æœ¯è°ƒç ”
> **ç›®çš„**: å°† CoDA çš„ä¸Šä¸‹æ–‡è§£è€¦æ€æƒ³èå…¥ Memory Anchor

---

## ä¸€ã€CoDA æ ¸å¿ƒæ€æƒ³æç‚¼

### 1.1 é—®é¢˜å®šä¹‰ï¼šä¸Šä¸‹æ–‡çˆ†ç‚¸ï¼ˆContext Explosionï¼‰

CoDA è§£å†³çš„æ ¸å¿ƒé—®é¢˜ä¸ Memory Anchor é«˜åº¦ç›¸ä¼¼ï¼š

| CoDA é—®é¢˜ | Memory Anchor é—®é¢˜ |
|----------|-------------------|
| ç´¯ç§¯çš„é•¿æ–‡æœ¬è¾“å‡ºæ·¹æ²¡ä¸Šä¸‹æ–‡çª—å£ | ä¸Šä¸‹æ–‡å‹ç¼©å¯¼è‡´ AI å¤±å¿† |
| ç­–ç•¥æ±¡æŸ“ï¼ˆè§„åˆ’è¢«å™ªå£°å¹²æ‰°ï¼‰ | å…³é”®å†³ç­–è¢«æ— å…³ä¿¡æ¯ç¨€é‡Š |
| æ‰§è¡Œå†—ä½™ï¼ˆå†å²ä»»åŠ¡æ±¡æŸ“å½“å‰ï¼‰ | å†å²è®°å¿†ä¸å½“å‰ä»»åŠ¡æ··æ·† |

### 1.2 CoDA è§£å†³æ–¹æ¡ˆï¼šä¸Šä¸‹æ–‡è§£è€¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CoDA æ¶æ„                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚   â”‚     Plannerï¼ˆè§„åˆ’å™¨ï¼‰                    â”‚               â”‚
â”‚   â”‚  - ç®€æ´çš„ç­–ç•¥ä¸Šä¸‹æ–‡                       â”‚               â”‚
â”‚   â”‚  - åªçœ‹ (taskâ‚, resultâ‚), ..., (taskâ‚™, resultâ‚™)         â”‚
â”‚   â”‚  - ä¸çœ‹åŸå§‹æ–‡æ¡£                          â”‚               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                    â”‚ å§”æ´¾å­ä»»åŠ¡                              â”‚
â”‚                    â–¼                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚   â”‚     Executorï¼ˆæ‰§è¡Œå™¨ï¼‰                   â”‚               â”‚
â”‚   â”‚  - ä¸´æ—¶éš”ç¦»çš„ä¸Šä¸‹æ–‡                       â”‚               â”‚
â”‚   â”‚  - åªçœ‹å½“å‰å­ä»»åŠ¡                        â”‚               â”‚
â”‚   â”‚  - è¿”å›ç²¾ç®€æ‘˜è¦ï¼ˆä¸æ˜¯åŸå§‹æ–‡æ¡£ï¼‰            â”‚               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                              â”‚
â”‚   ğŸ”‘ å…³é”®è®¾è®¡ï¼š                                              â”‚
â”‚   - å†—é•¿åŸå§‹æ–‡æ¡£ **æ°¸ä¸è¿›å…¥** è§„åˆ’å™¨ä¸Šä¸‹æ–‡                    â”‚
â”‚   - æ‰§è¡Œå™¨å……å½“"é»‘ç›’æ¨¡å—"ï¼Œè‡ªåŠ¨è¿‡æ»¤å™ªå£°                        â”‚
â”‚   - å•ä¸€ LLM æ‰®æ¼”ä¸¤ä¸ªè§’è‰²ï¼ˆå…±äº«å‚æ•°ï¼Œéš”ç¦»ä¸Šä¸‹æ–‡ï¼‰              â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 CoDA è®­ç»ƒæ–¹æ³•ï¼šPECO

- **Planner-Executor Co-Optimization**
- ç«¯åˆ°ç«¯å¼ºåŒ–å­¦ä¹ ï¼ˆGRPO ç®—æ³•ï¼‰
- ç»Ÿä¸€è½¨è¿¹çº§å¥–åŠ±ï¼Œè§’è‰²çº§ä¸Šä¸‹æ–‡ä¾èµ–æ›´æ–°
- æŸå¤±æ©ç åŒºåˆ†ï¼šä»£ç†åŠ¨ä½œ (mask=1) vs ç¯å¢ƒè§‚å¯Ÿ (mask=0)

### 1.4 CoDA æ•ˆæœ

| æŒ‡æ ‡ | ç»“æœ |
|------|------|
| å¤šè·³é—®ç­”å‡†ç¡®ç‡ | +6.0%ï¼ˆSOTAï¼‰|
| 2WikiMultiHopQA | +24.39% |
| é•¿ä¸Šä¸‹æ–‡é²æ£’æ€§ | ä¿æŒç¨³å®šï¼ˆå¯¹æ¯” AutoRefine ä¸‹é™ 52%ï¼‰|

---

## äºŒã€ç›¸å…³æŠ€æœ¯è°ƒç ”

### 2.1 ä¸Šä¸‹æ–‡å‹ç¼©ç­–ç•¥å¯¹æ¯”

| æ–¹æ³• | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ•ˆæœ |
|------|------|------|------|
| **Observation Masking** | ç®€å•ã€å¿«é€Ÿã€ä½æˆæœ¬ | ä¸¢å¤±ç»†èŠ‚ | æˆæœ¬é™ä½ 50%+ |
| **LLM Summarization** | ä¿ç•™è¯­ä¹‰ | å»¶é•¿è½¨è¿¹ 15%ã€å¢åŠ æˆæœ¬ | æ•ˆæœä¸å¦‚ Masking |
| **CoDA ä¸Šä¸‹æ–‡è§£è€¦** | ç»“æ„åŒ–éš”ç¦»ã€é²æ£’ | éœ€è¦è®­ç»ƒ | SOTA |
| **Acon å¤±è´¥é©±åŠ¨ä¼˜åŒ–** | è‡ªåŠ¨å­¦ä¹ å‹ç¼©æŒ‡å— | éœ€è¦è¿­ä»£ | é™ä½ 26-54% token |

### 2.2 JetBrains ç ”ç©¶å…³é”®å‘ç°

> æ¥æºï¼šhttps://blog.jetbrains.com/research/2025/12/efficient-context-management/

**æƒŠäººç»“è®º**ï¼šç®€å•çš„ Observation Masking **ä¼˜äº** LLM Summarization

- ä¸¤ç§æ–¹æ³•éƒ½èƒ½é™ä½ 50%+ æˆæœ¬
- Observation Masking åœ¨ 4/5 æµ‹è¯•ä¸­è¡¨ç°æ›´å¥½
- LLM Summarization å¯¼è‡´è½¨è¿¹å»¶é•¿ 15%

**æ¨èæ··åˆç­–ç•¥**ï¼š
1. ä¸»ç­–ç•¥ï¼šObservation Maskingï¼ˆä½æˆæœ¬ï¼‰
2. å¤‡ç”¨ç­–ç•¥ï¼šå½“ä¸Šä¸‹æ–‡"çœŸæ­£åºå¤§"æ—¶æ‰è§¦å‘ LLM å‹ç¼©

### 2.3 äº”å±‚è®°å¿†æ¶æ„ (MMAG)

> æ¥æºï¼šhttps://arxiv.org/html/2512.01710v1

| å±‚çº§ | è®¤çŸ¥å¯¹åº” | Memory Anchor å¯¹åº” |
|------|---------|-------------------|
| å¯¹è¯è®°å¿† | çŸ­æœŸå¯¹è¯ | L1 Active Context |
| é•¿æœŸç”¨æˆ·è®°å¿† | ç”¨æˆ·åå¥½ | L0 Identity Schema |
| æƒ…æ™¯äº‹ä»¶è®°å¿† | äº‹ä»¶é“¾æ¥ | L2 Event Log |
| æ„ŸçŸ¥ä¸Šä¸‹æ–‡è®°å¿† | ç¯å¢ƒæ„ŸçŸ¥ | (æ–°å¢) |
| çŸ­æœŸå·¥ä½œè®°å¿† | å³æ—¶æ“ä½œ | L1 Active Context |

---

## ä¸‰ã€Memory Anchor å¢å¼ºè®¾è®¡

### 3.1 æ ¸å¿ƒæ´å¯Ÿ

**CoDA ç»™æˆ‘ä»¬çš„å¯å‘**ï¼š

1. **ä¸Šä¸‹æ–‡è§£è€¦** â†’ Memory Anchor å¯ä»¥è®©æ£€ç´¢ç»“æœ"ç²¾ç®€åŒ–"ï¼Œè€Œä¸æ˜¯è¿”å›åŸå§‹å…¨æ–‡
2. **è§„åˆ’/æ‰§è¡Œåˆ†ç¦»** â†’ äº”å±‚è®°å¿†çš„"æ£€ç´¢"å’Œ"ä½¿ç”¨"å¯ä»¥è§£è€¦
3. **Observation Masking** â†’ æ—§è®°å¿†å¯ä»¥è¢«"æ‘˜è¦æ›¿ä»£"è€Œéå®Œå…¨åˆ é™¤

### 3.2 å¢å¼ºæ–¹æ¡ˆï¼šä¸Šä¸‹æ–‡è§£è€¦è®°å¿† (Context-Decoupled Memory)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Memory Anchor v3.0 å¢å¼ºæ¶æ„                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  L0: Identity Schema (å§‹ç»ˆå…¨é‡é¢„åŠ è½½)                  â”‚   â”‚
â”‚  â”‚  - æ ¸å¿ƒèº«ä»½ï¼Œæ°¸ä¸å‹ç¼©                                  â”‚   â”‚
â”‚  â”‚  - 500 tokens é¢„ç®—                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â˜… æ–°å¢ï¼šMemory Refinerï¼ˆè®°å¿†ç²¾ç‚¼å™¨ï¼‰                  â”‚   â”‚
â”‚  â”‚                                                        â”‚   â”‚
â”‚  â”‚  è¾“å…¥ï¼šsearch_memory() åŸå§‹ç»“æœ                        â”‚   â”‚
â”‚  â”‚  è¾“å‡ºï¼šç²¾ç®€æ‘˜è¦ï¼ˆå»å™ªã€å‹ç¼©ã€ä¿ç•™å…³é”®ä¿¡æ¯ï¼‰               â”‚   â”‚
â”‚  â”‚                                                        â”‚   â”‚
â”‚  â”‚  æµç¨‹ï¼š                                                â”‚   â”‚
â”‚  â”‚  1. æ£€ç´¢åŸå§‹è®°å¿†ï¼ˆå¯èƒ½å¾ˆé•¿ï¼‰                            â”‚   â”‚
â”‚  â”‚  2. åœ¨éš”ç¦»ä¸Šä¸‹æ–‡ä¸­ç²¾ç‚¼                                  â”‚   â”‚
â”‚  â”‚  3. è¿”å›ç²¾ç®€æ‘˜è¦åˆ°ä¸»ä¸Šä¸‹æ–‡                              â”‚   â”‚
â”‚  â”‚                                                        â”‚   â”‚
â”‚  â”‚  ç±»æ¯” CoDAï¼š                                           â”‚   â”‚
â”‚  â”‚  - Planner = AI ä¸»å¯¹è¯                                 â”‚   â”‚
â”‚  â”‚  - Executor = Memory Refiner                          â”‚   â”‚
â”‚  â”‚  - åŸå§‹æ–‡æ¡£ = åŸå§‹è®°å¿†                                  â”‚   â”‚
â”‚  â”‚  - ç²¾ç®€ç»“æœ = ç²¾ç‚¼åçš„æ‘˜è¦                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  L2/L3: åˆ†å±‚æ£€ç´¢ + è‡ªåŠ¨å‹ç¼©                            â”‚   â”‚
â”‚  â”‚                                                        â”‚   â”‚
â”‚  â”‚  ç­–ç•¥ 1: Observation Maskingï¼ˆç®€å•é«˜æ•ˆï¼‰               â”‚   â”‚
â”‚  â”‚  - æœ€è¿‘ N æ¡è®°å¿†ï¼šå…¨æ–‡                                 â”‚   â”‚
â”‚  â”‚  - æ›´æ—©çš„è®°å¿†ï¼šæ›¿æ¢ä¸º [è®°å¿†å­˜åœ¨ï¼Œå†…å®¹å·²å‹ç¼©]             â”‚   â”‚
â”‚  â”‚                                                        â”‚   â”‚
â”‚  â”‚  ç­–ç•¥ 2: å±‚çº§ç²¾ç‚¼ï¼ˆéœ€è¦æ—¶è§¦å‘ï¼‰                         â”‚   â”‚
â”‚  â”‚  - å½“æ€» token > é˜ˆå€¼æ—¶ï¼Œè§¦å‘ LLM ç²¾ç‚¼                  â”‚   â”‚
â”‚  â”‚  - ç”Ÿæˆ"è®°å¿†æ‘˜è¦"ï¼Œä¿ç•™æ ¸å¿ƒè¯­ä¹‰                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  L1: Active Context (å·¥ä½œè®°å¿†)                         â”‚   â”‚
â”‚  â”‚  - å½“å‰ä¼šè¯çŠ¶æ€                                        â”‚   â”‚
â”‚  â”‚  - è‡ªåŠ¨è¿‡æœŸï¼ˆ1å°æ—¶ TTLï¼‰                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 æ–°å¢ MCP å·¥å…·è®¾è®¡

#### 3.3.1 `refine_memory` - è®°å¿†ç²¾ç‚¼å™¨

```python
def refine_memory(
    query: str,
    raw_memories: List[Dict],
    max_output_tokens: int = 500,
    focus: str = "key_decisions"
) -> Dict:
    """
    å°†åŸå§‹è®°å¿†ç²¾ç‚¼ä¸ºç²¾ç®€æ‘˜è¦ï¼ˆç±»ä¼¼ CoDA Executorï¼‰

    Args:
        query: ç”¨æˆ·åŸå§‹æŸ¥è¯¢
        raw_memories: search_memory è¿”å›çš„åŸå§‹ç»“æœ
        max_output_tokens: è¾“å‡ºæœ€å¤§ token æ•°
        focus: ç²¾ç‚¼ç„¦ç‚¹ ("key_decisions" | "facts" | "timeline")

    Returns:
        {
            "refined_summary": "ç²¾ç‚¼åçš„æ‘˜è¦",
            "key_points": ["å…³é”®ç‚¹1", "å…³é”®ç‚¹2"],
            "sources": ["åŸå§‹è®°å¿†IDåˆ—è¡¨"],
            "compression_ratio": 0.3  # å‹ç¼©æ¯”
        }
    """
```

#### 3.3.2 `search_memory_refined` - ç²¾ç‚¼æœç´¢ï¼ˆä¸€æ­¥åˆ°ä½ï¼‰

```python
def search_memory_refined(
    query: str,
    limit: int = 5,
    auto_refine: bool = True,
    refine_threshold: int = 1000  # è¶…è¿‡ 1000 tokens è‡ªåŠ¨ç²¾ç‚¼
) -> Dict:
    """
    æœç´¢ + è‡ªåŠ¨ç²¾ç‚¼ï¼ˆæ¨èçš„é»˜è®¤ APIï¼‰

    æµç¨‹ï¼š
    1. æ‰§è¡Œ search_memory(query, limit)
    2. è®¡ç®—æ€» token æ•°
    3. å¦‚æœ > threshold ä¸” auto_refine=Trueï¼Œè§¦å‘ç²¾ç‚¼
    4. è¿”å›ç²¾ç‚¼åçš„ç»“æœ

    Returns:
        {
            "memories": [...],  # ç²¾ç‚¼åçš„è®°å¿†
            "was_refined": True,
            "original_tokens": 2500,
            "refined_tokens": 450,
            "compression_ratio": 0.18
        }
    """
```

#### 3.3.3 `compress_old_memories` - å†å²å‹ç¼©

```python
def compress_old_memories(
    layer: str = "event_log",
    older_than_days: int = 7,
    strategy: str = "summarize"  # "summarize" | "mask" | "archive"
) -> Dict:
    """
    å‹ç¼©æ—§è®°å¿†ï¼ˆç±»ä¼¼ Observation Maskingï¼‰

    ç­–ç•¥ï¼š
    - summarize: ç”Ÿæˆæ‘˜è¦æ›¿ä»£åŸæ–‡
    - mask: ä¿ç•™å…ƒæ•°æ®ï¼Œå†…å®¹æ›¿æ¢ä¸ºå ä½ç¬¦
    - archive: ç§»åŠ¨åˆ°å½’æ¡£å±‚

    Returns:
        {
            "compressed_count": 42,
            "saved_tokens": 15000,
            "strategy": "summarize"
        }
    """
```

### 3.4 ä¸Šä¸‹æ–‡é¢„ç®—åˆ†é…ï¼ˆä¼˜åŒ–ç‰ˆï¼‰

| å±‚ | é¢„ç®— | å‹ç¼©ç­–ç•¥ |
|---|------|---------|
| L0 Identity Schema | 500 tokens | æ°¸ä¸å‹ç¼© |
| L2 Event Log (æœ€è¿‘ 3 å¤©) | 500 tokens | å…¨æ–‡ |
| L2 Event Log (æ›´æ—©) | 200 tokens | Observation Masking |
| L3 Verified Fact | 800 tokens | æŒ‰ç›¸å…³åº¦æˆªæ–­ |
| ç²¾ç‚¼æ‘˜è¦ | 500 tokens | LLM ç²¾ç‚¼è¾“å‡º |
| **æ€»é¢„ç®—** | **2500 tokens** | |

### 3.5 å®ç°è·¯çº¿å›¾

#### Phase 1: åŸºç¡€ç²¾ç‚¼ï¼ˆ2 å‘¨ï¼‰

- [ ] å®ç° `MemoryRefiner` ç±»ï¼ˆå€Ÿé‰´ CoDA Executorï¼‰
- [ ] æ·»åŠ  `refine_memory` MCP å·¥å…·
- [ ] æ·»åŠ  `search_memory_refined` API
- [ ] å•å…ƒæµ‹è¯•ï¼šå‹ç¼©æ¯”ã€ä¿¡æ¯ä¿ç•™ç‡

#### Phase 2: è‡ªåŠ¨å‹ç¼©ï¼ˆ1 å‘¨ï¼‰

- [ ] å®ç° Observation Masking ç­–ç•¥
- [ ] æ·»åŠ  `compress_old_memories` å·¥å…·
- [ ] å®šæ—¶ä»»åŠ¡ï¼šæ¯æ—¥è‡ªåŠ¨å‹ç¼© 7 å¤©å‰çš„ L2 è®°å¿†

#### Phase 3: æ™ºèƒ½è·¯ç”±ï¼ˆ2 å‘¨ï¼‰

- [ ] æ ¹æ®æŸ¥è¯¢ç±»å‹è‡ªåŠ¨é€‰æ‹©ç²¾ç‚¼ç­–ç•¥
- [ ] å®ç°"åˆ†å±‚ç²¾ç‚¼"ï¼ˆå…ˆç²—åç»†ï¼‰
- [ ] A/B æµ‹è¯•ï¼šç²¾ç‚¼ vs ä¸ç²¾ç‚¼çš„æ•ˆæœå¯¹æ¯”

---

## å››ã€æŠ€æœ¯å®ç°ç»†èŠ‚

### 4.1 Memory Refiner æ ¸å¿ƒé€»è¾‘

```python
class MemoryRefiner:
    """
    è®°å¿†ç²¾ç‚¼å™¨ï¼ˆå€Ÿé‰´ CoDA Executor è®¾è®¡ï¼‰

    æ ¸å¿ƒæ€æƒ³ï¼šåœ¨éš”ç¦»ä¸Šä¸‹æ–‡ä¸­å¤„ç†åŸå§‹è®°å¿†ï¼Œè¿”å›ç²¾ç®€æ‘˜è¦ã€‚
    """

    def __init__(self, model: str = "haiku"):
        """
        ä½¿ç”¨å°æ¨¡å‹åšç²¾ç‚¼ï¼ˆæˆæœ¬ä½ã€é€Ÿåº¦å¿«ï¼‰
        """
        self.model = model

    def refine(
        self,
        query: str,
        memories: List[Dict],
        max_tokens: int = 500
    ) -> Dict:
        """
        ç²¾ç‚¼è®°å¿†

        Prompt è®¾è®¡ï¼ˆç±»ä¼¼ CoDA çš„ Refine æ­¥éª¤ï¼‰ï¼š
        1. ç»™å®šç”¨æˆ·æŸ¥è¯¢
        2. ç»™å®šåŸå§‹è®°å¿†åˆ—è¡¨
        3. è¦æ±‚æå–ä¸æŸ¥è¯¢ç›¸å…³çš„å…³é”®ä¿¡æ¯
        4. è¾“å‡ºä¸è¶…è¿‡ max_tokens
        """
        prompt = f"""
ä½ æ˜¯ä¸€ä¸ªè®°å¿†ç²¾ç‚¼åŠ©æ‰‹ã€‚ç»™å®šç”¨æˆ·æŸ¥è¯¢å’ŒåŸå§‹è®°å¿†åˆ—è¡¨ï¼Œæå–æœ€ç›¸å…³çš„å…³é”®ä¿¡æ¯ã€‚

ã€ç”¨æˆ·æŸ¥è¯¢ã€‘
{query}

ã€åŸå§‹è®°å¿†ã€‘
{self._format_memories(memories)}

ã€ä»»åŠ¡ã€‘
1. è¯†åˆ«ä¸æŸ¥è¯¢æœ€ç›¸å…³çš„ä¿¡æ¯
2. å»é™¤å†—ä½™å’Œå™ªå£°
3. ä¿ç•™å…³é”®å†³ç­–ã€äº‹å®ã€æ—¶é—´çº¿
4. è¾“å‡ºä¸è¶…è¿‡ {max_tokens} tokens

ã€è¾“å‡ºæ ¼å¼ã€‘
- æ ¸å¿ƒæ‘˜è¦ï¼šï¼ˆä¸€æ®µè¯æ€»ç»“ï¼‰
- å…³é”®ç‚¹ï¼š
  1. ...
  2. ...
"""
        # è°ƒç”¨ LLM ç²¾ç‚¼
        result = self._call_llm(prompt)

        return {
            "refined_summary": result["summary"],
            "key_points": result["key_points"],
            "sources": [m["id"] for m in memories],
            "compression_ratio": len(result["summary"]) / self._total_length(memories)
        }
```

### 4.2 Observation Masking å®ç°

```python
def apply_observation_masking(
    memories: List[Dict],
    keep_recent: int = 3,
    mask_text: str = "[å†…å®¹å·²å‹ç¼©ï¼Œå¯é€šè¿‡ ID æŸ¥è¯¢åŸæ–‡]"
) -> List[Dict]:
    """
    åº”ç”¨ Observation Maskingï¼ˆç®€å•é«˜æ•ˆçš„å‹ç¼©ç­–ç•¥ï¼‰

    ç­–ç•¥ï¼šä¿ç•™æœ€è¿‘ N æ¡è®°å¿†å…¨æ–‡ï¼Œæ›´æ—©çš„ç”¨å ä½ç¬¦æ›¿ä»£ã€‚

    Args:
        memories: æŒ‰æ—¶é—´å€’åºæ’åˆ—çš„è®°å¿†åˆ—è¡¨
        keep_recent: ä¿ç•™æœ€è¿‘ N æ¡å…¨æ–‡
        mask_text: å ä½ç¬¦æ–‡æœ¬

    Returns:
        å‹ç¼©åçš„è®°å¿†åˆ—è¡¨
    """
    result = []
    for i, memory in enumerate(memories):
        if i < keep_recent:
            # æœ€è¿‘çš„ï¼šä¿ç•™å…¨æ–‡
            result.append(memory)
        else:
            # æ›´æ—©çš„ï¼šåªä¿ç•™å…ƒæ•°æ® + å ä½ç¬¦
            masked = {
                "id": memory["id"],
                "layer": memory["layer"],
                "created_at": memory["created_at"],
                "content": mask_text,
                "is_masked": True
            }
            result.append(masked)

    return result
```

---

## äº”ã€é¢„æœŸæ•ˆæœ

### 5.1 é‡åŒ–ç›®æ ‡

| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ | æ”¹è¿› |
|------|------|------|------|
| å¹³å‡ä¸Šä¸‹æ–‡ token | ~3000 | ~1500 | -50% |
| è®°å¿†æ£€ç´¢å»¶è¿Ÿ | 200ms | 150ms | -25% |
| å…³é”®ä¿¡æ¯å¬å›ç‡ | 80% | 90% | +10% |
| ä¸Šä¸‹æ–‡å‹ç¼©åä¿¡æ¯ä¸¢å¤± | æœªçŸ¥ | <5% | å¯æ§ |

### 5.2 å®šæ€§ç›®æ ‡

- âœ… AI åœ¨é•¿ä¼šè¯ä¸­ä¿æŒå¯¹å…³é”®å†³ç­–çš„"è®°å¿†"
- âœ… è‡ªåŠ¨è¿‡æ»¤å™ªå£°ï¼Œå‡å°‘"ä¿¡æ¯ç¨€é‡Š"
- âœ… æ”¯æŒæ›´é•¿çš„å·¥ä½œä¼šè¯è€Œä¸è¶…å‡ºä¸Šä¸‹æ–‡é™åˆ¶

---

## å…­ã€å‚è€ƒèµ„æº

### è®ºæ–‡

- [CoDA: A Context-Decoupled Hierarchical Agent with Reinforcement Learning](https://arxiv.org/abs/2512.12716)
- [Acon: Optimizing Context Compression for Long-horizon LLM Agents](https://arxiv.org/html/2510.00615)
- [MemoRAG: Boosting Long Context Processing with Global Memory-Enhanced Retrieval](https://arxiv.org/abs/2409.05591)

### ä»£ç 

- [CoDA GitHub](https://github.com/liuxuanzhang718/CoDA)
- [OpenPipe ART (Agent Reinforcement Trainer)](https://github.com/OpenPipe/ART)

### åšå®¢

- [JetBrains: Cutting Through the Noise - Smarter Context Management](https://blog.jetbrains.com/research/2025/12/efficient-context-management/)
- [Letta: RAG is not Agent Memory](https://www.letta.com/blog/rag-vs-agent-memory)
- [mem0: LLM Chat History Summarization Guide 2025](https://mem0.ai/blog/llm-chat-history-summarization-guide-2025)

---

## ä¸ƒã€ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³å¯åš**ï¼šå®ç° `apply_observation_masking` å‡½æ•°
2. **æœ¬å‘¨**ï¼šè®¾è®¡ `MemoryRefiner` ç±»çš„å®Œæ•´æ¥å£
3. **ä¸‹å‘¨**ï¼šæ·»åŠ  `refine_memory` MCP å·¥å…·
4. **é‡Œç¨‹ç¢‘**ï¼šMemory Anchor v3.0 å‘å¸ƒï¼ˆå«ä¸Šä¸‹æ–‡è§£è€¦èƒ½åŠ›ï¼‰

---

> ğŸ“ **è®°å¿†å†™å…¥å€™é€‰**
>
> ```json
> {
>   "type": "decision",
>   "summary": "å†³å®šå€Ÿé‰´ CoDA çš„ä¸Šä¸‹æ–‡è§£è€¦æ€æƒ³å¢å¼º Memory Anchorï¼Œæ ¸å¿ƒæ˜¯æ·»åŠ  Memory Refinerï¼ˆè®°å¿†ç²¾ç‚¼å™¨ï¼‰ï¼Œåœ¨éš”ç¦»ä¸Šä¸‹æ–‡ä¸­å°†åŸå§‹è®°å¿†å‹ç¼©ä¸ºç²¾ç®€æ‘˜è¦",
>   "layer": "verified_fact",
>   "tags": ["architecture", "coda", "context-decoupling", "memory-refiner"]
> }
> ```
