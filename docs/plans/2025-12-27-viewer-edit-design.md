# Memory Anchor Viewer 编辑功能设计

> 日期：2025-12-27
> 状态：设计完成，待实现

## 背景

Memory Anchor Viewer Web UI 已完成只读浏览功能，需要扩展编辑能力。

## 目标用户

- **AI 助手**：Claude Code + chrome 操作浏览器查看/编辑记忆
- **开发者社区**：开源后给其他 Memory Anchor 用户使用

## 功能优先级

| 优先级 | 功能 | 说明 |
|--------|------|------|
| P0 | 快速验证 | 在 UI 上一键确认/删除记忆 |
| P1 | 上下文恢复 | 会话压缩后快速回顾关键决策 |
| P2 | 记忆管理 | 批量清理过期/低质量记忆 |
| P3 | 可视化调试 | 时间线/知识图谱（后续） |

## 交互设计

### 卡片交互增强

```
┌─────────────────────────────────────────────┐
│ ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓ (层级色条)                   │
│                                             │
│  [L3 验证事实] [📅 事件] [⚠️ 95%]    [✓] [✗] │  ← 确认/删除按钮
│                                             │
│  修复 Memory Anchor MCP 环境变量问题...      │
│                                             │
│  会话: xxx  关联文件: config.py              │
│  ─────────────────────────────────────────  │
│  2 天前                          3d51cca6   │
└─────────────────────────────────────────────┘
        ↓ 点击卡片
    打开详情弹窗
```

**按钮行为：**

| 按钮 | 动作 | 确认 |
|------|------|------|
| ✓ 确认 | confidence → 1.0 | 无需确认 |
| ✗ 删除 | 软删除记忆 | 弹出确认对话框 |

### 详情弹窗

```
┌──────────────────────────────────────────────────────┐
│  记忆详情                                    [×] 关闭 │
├──────────────────────────────────────────────────────┤
│  ┌─ 基础信息 ─────────────────────────────────────┐  │
│  │ ID        3d51cca6-36ae-4098-9da6-9bc7b7ceb4d5 │  │
│  │ 层级      L3 验证事实                          │  │
│  │ 分类      📅 事件                              │  │
│  │ 置信度    95% ⚠️                               │  │
│  │ 创建时间  2025-12-25 11:44                     │  │
│  │ 来源      ai_extraction                        │  │
│  └────────────────────────────────────────────────┘  │
│                                                      │
│  ┌─ 内容 ──────────────────────────── [编辑] ────┐  │
│  │ 修复 Memory Anchor MCP 环境变量问题...         │  │
│  └────────────────────────────────────────────────┘  │
│                                                      │
│  ┌─ 关联信息 ─────────────────────── [编辑] ────┐  │
│  │ 会话 ID      (空)              [+ 添加]       │  │
│  │ 关联文件    (空)              [+ 添加]       │  │
│  └────────────────────────────────────────────────┘  │
│                                                      │
│  ┌─ JSON 原始数据 ──────────────────── [复制] ───┐  │
│  │ { "id": "3d51cca6-...", ... }        ▼ 折叠   │  │
│  └────────────────────────────────────────────────┘  │
│                                                      │
│  ┌────────────────────────────────────────────────┐  │
│  │  [✓ 确认记忆]    [保存修改]    [🗑️ 删除]       │  │
│  └────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────┘
```

**弹窗功能：**

| 区域 | 功能 |
|------|------|
| 基础信息 | 只读展示全部字段 |
| 内容 | 点击[编辑]进入编辑模式 |
| 关联信息 | 添加/编辑 session_id、related_files |
| JSON | 默认折叠，展开可复制（开发者调试） |
| 底部按钮 | 确认/保存/删除 |

## API 设计

### 新增端点

| 方法 | 路径 | 功能 |
|------|------|------|
| `PATCH` | `/api/v1/notes/{id}` | 更新记忆 |
| `POST` | `/api/v1/notes/{id}/verify` | 确认记忆 |
| `DELETE` | `/api/v1/notes/{id}` | 删除记忆 |

### 请求格式

```typescript
// PATCH /api/v1/notes/{id}
{
  content?: string,
  session_id?: string,
  related_files?: string[]
}

// POST /api/v1/notes/{id}/verify
{
  verified_by: "human"
}

// DELETE /api/v1/notes/{id}
{
  confirmation: "确认删除"
}
```

## 前端组件

```
frontend/viewer/src/
├── components/
│   ├── MemoryCard.tsx        # 修改：添加操作按钮
│   ├── MemoryDetail.tsx      # 新增：详情弹窗
│   ├── MemoryEditor.tsx      # 新增：内容编辑器
│   ├── JsonViewer.tsx        # 新增：JSON 折叠展示
│   └── ConfirmDialog.tsx     # 新增：删除确认对话框
├── api/
│   └── memory.ts             # 修改：添加 PATCH/DELETE/verify
└── hooks/
    └── useMemoryActions.ts   # 新增：操作 hook
```

## 实现计划

| 阶段 | 内容 | 工作量 |
|------|------|--------|
| Phase 1 | 卡片按钮 + 确认/删除 API | 小 |
| Phase 2 | 详情弹窗（只读 + JSON） | 中 |
| Phase 3 | 内容编辑 + 保存 | 中 |
| Phase 4 | 关联信息编辑 | 小 |

### Phase 1 任务

**后端：**
- [ ] POST /api/v1/notes/{id}/verify
- [ ] DELETE /api/v1/notes/{id}

**前端：**
- [ ] MemoryCard.tsx 添加 ✓/✗ 按钮
- [ ] ConfirmDialog.tsx 删除确认弹窗
- [ ] api/memory.ts 添加 verify/delete
- [ ] useMemoryActions.ts hook

### Phase 2 任务

- [ ] MemoryDetail.tsx 弹窗组件
- [ ] JsonViewer.tsx 折叠 JSON
- [ ] 点击卡片打开弹窗逻辑

### Phase 3-4 任务

- [ ] MemoryEditor.tsx 编辑器
- [ ] 关联信息编辑 UI
- [ ] PATCH API 集成

## 决策记录

| 决策 | 选择 | 原因 |
|------|------|------|
| 层级调整 | 不做 | 危险操作，暂不开放 |
| 历史记录 | 不做 | 增加复杂度，后续再说 |
| 批量操作 | 后续 | P0 先做单条操作 |
